<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->

- [雅虎前端优化的 35 条军规](#%E9%9B%85%E8%99%8E%E5%89%8D%E7%AB%AF%E4%BC%98%E5%8C%96%E7%9A%84-35-%E6%9D%A1%E5%86%9B%E8%A7%84)
  - [一、内容部分](#%E4%B8%80%E5%86%85%E5%AE%B9%E9%83%A8%E5%88%86)
    - [（一）尽量减少 HTTP 请求数](#%E4%B8%80%E5%B0%BD%E9%87%8F%E5%87%8F%E5%B0%91-http-%E8%AF%B7%E6%B1%82%E6%95%B0)
    - [（二）减少 DNS 查找](#%E4%BA%8C%E5%87%8F%E5%B0%91-dns-%E6%9F%A5%E6%89%BE)
    - [（三）避免重定向](#%E4%B8%89%E9%81%BF%E5%85%8D%E9%87%8D%E5%AE%9A%E5%90%91)
    - [（四）让 Ajax 可缓存](#%E5%9B%9B%E8%AE%A9-ajax-%E5%8F%AF%E7%BC%93%E5%AD%98)
    - [（五）延迟加载组件](#%E4%BA%94%E5%BB%B6%E8%BF%9F%E5%8A%A0%E8%BD%BD%E7%BB%84%E4%BB%B6)
    - [（六）预加载组件](#%E5%85%AD%E9%A2%84%E5%8A%A0%E8%BD%BD%E7%BB%84%E4%BB%B6)
    - [（七）减少 DOM 元素的数量](#%E4%B8%83%E5%87%8F%E5%B0%91-dom-%E5%85%83%E7%B4%A0%E7%9A%84%E6%95%B0%E9%87%8F)
    - [（八）跨域分离组件](#%E5%85%AB%E8%B7%A8%E5%9F%9F%E5%88%86%E7%A6%BB%E7%BB%84%E4%BB%B6)
    - [（九）尽量少用 iframe](#%E4%B9%9D%E5%B0%BD%E9%87%8F%E5%B0%91%E7%94%A8-iframe)
    - [（十）杜绝 404](#%E5%8D%81%E6%9D%9C%E7%BB%9D-404)
  - [二、CSS 部分](#%E4%BA%8Ccss-%E9%83%A8%E5%88%86)
    - [（十一）合理使用 CSS 表达式](#%E5%8D%81%E4%B8%80%E5%90%88%E7%90%86%E4%BD%BF%E7%94%A8-css-%E8%A1%A8%E8%BE%BE%E5%BC%8F)
    - [（十二）尽量选择`<link>`少用`@import`](#%E5%8D%81%E4%BA%8C%E5%B0%BD%E9%87%8F%E9%80%89%E6%8B%A9link%E5%B0%91%E7%94%A8import)
    - [（十三）避免使用滤镜](#%E5%8D%81%E4%B8%89%E9%81%BF%E5%85%8D%E4%BD%BF%E7%94%A8%E6%BB%A4%E9%95%9C)
    - [（十四）把样式表放在顶部](#%E5%8D%81%E5%9B%9B%E6%8A%8A%E6%A0%B7%E5%BC%8F%E8%A1%A8%E6%94%BE%E5%9C%A8%E9%A1%B6%E9%83%A8)
  - [三、JS 部分](#%E4%B8%89js-%E9%83%A8%E5%88%86)
    - [（十五）去除重复脚本](#%E5%8D%81%E4%BA%94%E5%8E%BB%E9%99%A4%E9%87%8D%E5%A4%8D%E8%84%9A%E6%9C%AC)
    - [（十六）尽量减少 DOM 访问](#%E5%8D%81%E5%85%AD%E5%B0%BD%E9%87%8F%E5%87%8F%E5%B0%91-dom-%E8%AE%BF%E9%97%AE)
    - [（十七）用智能的事件处理器](#%E5%8D%81%E4%B8%83%E7%94%A8%E6%99%BA%E8%83%BD%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E5%99%A8)
    - [（十八）把脚本放在底部](#%E5%8D%81%E5%85%AB%E6%8A%8A%E8%84%9A%E6%9C%AC%E6%94%BE%E5%9C%A8%E5%BA%95%E9%83%A8)
  - [四、JavaScript、CSS](#%E5%9B%9Bjavascriptcss)
    - [（十九）把 JavaScript 和 CSS 放到外面](#%E5%8D%81%E4%B9%9D%E6%8A%8A-javascript-%E5%92%8C-css-%E6%94%BE%E5%88%B0%E5%A4%96%E9%9D%A2)
    - [（二十）压缩 JavaScript 和 CSS](#%E4%BA%8C%E5%8D%81%E5%8E%8B%E7%BC%A9-javascript-%E5%92%8C-css)
  - [五、图片](#%E4%BA%94%E5%9B%BE%E7%89%87)
    - [（二十一）优化图片](#%E4%BA%8C%E5%8D%81%E4%B8%80%E4%BC%98%E5%8C%96%E5%9B%BE%E7%89%87)
    - [（二十二）优化 CSS Sprite](#%E4%BA%8C%E5%8D%81%E4%BA%8C%E4%BC%98%E5%8C%96-css-sprite)
    - [（二十三）不要用 HTML/CSS 缩放图片](#%E4%BA%8C%E5%8D%81%E4%B8%89%E4%B8%8D%E8%A6%81%E7%94%A8-htmlcss-%E7%BC%A9%E6%94%BE%E5%9B%BE%E7%89%87)
    - [（二十四）用小的可缓存的 favicon.ico（P.S. 收藏夹图标）](#%E4%BA%8C%E5%8D%81%E5%9B%9B%E7%94%A8%E5%B0%8F%E7%9A%84%E5%8F%AF%E7%BC%93%E5%AD%98%E7%9A%84-faviconicops-%E6%94%B6%E8%97%8F%E5%A4%B9%E5%9B%BE%E6%A0%87)
  - [六、Cookie](#%E5%85%ADcookie)
    - [（二十五）尽量减少 Cookie 的大小](#%E4%BA%8C%E5%8D%81%E4%BA%94%E5%B0%BD%E9%87%8F%E5%87%8F%E5%B0%91-cookie-%E7%9A%84%E5%A4%A7%E5%B0%8F)
    - [（二十六）把组件放在不含 Cookie 的域下](#%E4%BA%8C%E5%8D%81%E5%85%AD%E6%8A%8A%E7%BB%84%E4%BB%B6%E6%94%BE%E5%9C%A8%E4%B8%8D%E5%90%AB-cookie-%E7%9A%84%E5%9F%9F%E4%B8%8B)
  - [七、移动端](#%E4%B8%83%E7%A7%BB%E5%8A%A8%E7%AB%AF)
    - [（二十七）保证所有组件都小于 25K](#%E4%BA%8C%E5%8D%81%E4%B8%83%E4%BF%9D%E8%AF%81%E6%89%80%E6%9C%89%E7%BB%84%E4%BB%B6%E9%83%BD%E5%B0%8F%E4%BA%8E-25k)
    - [（二十八）把组件打包到一个复合文档里](#%E4%BA%8C%E5%8D%81%E5%85%AB%E6%8A%8A%E7%BB%84%E4%BB%B6%E6%89%93%E5%8C%85%E5%88%B0%E4%B8%80%E4%B8%AA%E5%A4%8D%E5%90%88%E6%96%87%E6%A1%A3%E9%87%8C)
  - [八、服务器](#%E5%85%AB%E6%9C%8D%E5%8A%A1%E5%99%A8)
    - [（二十九）Gzip 组件](#%E4%BA%8C%E5%8D%81%E4%B9%9Dgzip-%E7%BB%84%E4%BB%B6)
    - [（三十）避免图片 src 属性为空](#%E4%B8%89%E5%8D%81%E9%81%BF%E5%85%8D%E5%9B%BE%E7%89%87-src-%E5%B1%9E%E6%80%A7%E4%B8%BA%E7%A9%BA)
    - [（三十一）配置 ETags](#%E4%B8%89%E5%8D%81%E4%B8%80%E9%85%8D%E7%BD%AE-etags)
    - [（三十二）对 Ajax 用 GET 请求](#%E4%B8%89%E5%8D%81%E4%BA%8C%E5%AF%B9-ajax-%E7%94%A8-get-%E8%AF%B7%E6%B1%82)
    - [（三十三）尽早清空缓冲区](#%E4%B8%89%E5%8D%81%E4%B8%89%E5%B0%BD%E6%97%A9%E6%B8%85%E7%A9%BA%E7%BC%93%E5%86%B2%E5%8C%BA)
    - [（三十四）使用 CDN（内容分发网络）](#%E4%B8%89%E5%8D%81%E5%9B%9B%E4%BD%BF%E7%94%A8-cdn%E5%86%85%E5%AE%B9%E5%88%86%E5%8F%91%E7%BD%91%E7%BB%9C)
    - [（三十五）添上 Expires 或者 Cache-Control HTTP 请求头](#%E4%B8%89%E5%8D%81%E4%BA%94%E6%B7%BB%E4%B8%8A-expires-%E6%88%96%E8%80%85-cache-control-http-%E8%AF%B7%E6%B1%82%E5%A4%B4)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

# 雅虎前端优化的 35 条军规

参考资料：https://www.cnblogs.com/xianyulaodi/p/5755079.html

摘要：无论是在工作中，还是在面试中，web 前端性能的优化都是很重要的，那么我们进行优化需要从哪些方面入手呢？可以遵循雅虎的前端优化 35 条军规。已分类，对优化有一个比较清晰的方向。

## 一、内容部分

### （一）尽量减少 HTTP 请求数

80%的终端用户响应时间都花在了前端上，其中大部分时间都在下载页面上的各种组件：图片，样式表，脚本，Flash 等等。减少组件数必然能够减少页面提交的 HTTP 请求数。这是让页面更快的关键。

减少页面组件数的一种方式是简化页面设计。但有没有一种方法可以在构建复杂的页面同时加快响应时间呢？嗯，确实有鱼和熊掌兼得的办法。

1. **合并文件**是通过把所有脚本放在一个文件中的方式来减少请求数的，当然，也可以合并所有的 CSS。如果各个页面的脚本和样式不一样的话，合并文件就是一项比较麻烦的工作了，但把这个作为站点发布过程的一部分确实可以提高响应时间。
2. **CSS Sprites**是减少图片请求数量的首选方式。把背景图片都整合到一张图片中，然后用 CSS 的 background-image 和 background-position 属性来定位要显示的部分。
3. **图像映射**可以把多张图片合并成单张图片，总大小是一样的，但减少了请求数并加速了页面加载。图片映射只有在图像在页面中连续的时候才有用，比如导航条。给 image map 设置坐标的过程既无聊又容易出错，用 image map 来做导航也不容易，所以不推荐用这种方式。
4. **行内图片（Base64 编码）用 data**: URL 模式来把图片嵌入页面。这样会增加 HTML 文件的大小，把行内图片放在（缓存的）样式表中是个好办法，而且成功避免了页面变“重”。但目前主流浏览器并不能很好地支持行内图片。

减少页面的 HTTP 请求数是个起点，这是提升站点首次访问速度的重要指导原则。

### （二）减少 DNS 查找

域名系统建立了主机名和 IP 地址间的映射，就像电话簿上人名和号码的映射一样。当你在浏览器输入www.yahoo.com的时候，浏览器就会联系DNS解析器返回服务器的IP地址。DNS是有成本的，它需要20到120毫秒去查找给定主机名的IP地址。在DNS查找完成之前，浏览器无法从主机名下载任何东西。

DNS 查找被缓存起来更高效，由用户的 ISP（网络服务提供商）或者本地网络存在一个特殊的缓存服务器上，但还可以缓存在个人用户的计算机上。DNS 信息被保存在操作系统的 DNS cache(微软 Windows 上的”DNS 客户端服务”)里。大多数浏览器有独立于操作系统的自己的 cache。只要浏览器在自己的 cache 里还保留着这条记录，它就不会向操作系统查询 DNS。

IE 默认缓存 DNS 查找 30 分钟，写在 DnsCacheTimeout 注册表设置中。Firefox 缓存 1 分钟，可以用 network.dnsCacheExpiration 配置项设置。(Fasterfox 把缓存时间改成了 1 小时 P.S. Fasterfox 是 FF 的一个提速插件)

如果客户端的 DNS cache 是空的（包括浏览器的和操作系统的），DNS 查找数等于页面上不同的主机名数，包括页面 URL，图片，脚本文件，样式表，Flash 对象等等组件中的主机名，减少不同的主机名就可以减少 DNS 查找。

减少不同主机名的数量同时也减少了页面能够并行下载的组件数量，避免 DNS 查找削减了响应时间，而减少并行下载数量却增加了响应时间。我的原则是把组件分散在 2 到 4 个主机名下，这是同时减少 DNS 查找和允许高并发下载的折中方案。

### （三）避免重定向

重定向用 301 和 302 状态码，下面是一个有 301 状态码的 HTTP 头：

```
HTTP/1.1 301 Moved Permanently
      Location: http://example.com/newuri
      Content-Type: text/html
```

浏览器会自动跳转到 Location 域指明的 URL。重定向需要的所有信息都在 HTTP 头部，而响应体一般是空的。其实额外的 HTTP 头，比如 Expires 和 Cache-Control 也表示重定向。除此之外还有别的跳转方式：refresh 元标签和 JavaScript，但如果你必须得做重定向，最好用标准的 3xxHTTP 状态码，主要是为了让返回按钮能正常使用。

牢记重定向会拖慢用户体验，在用户和 HTML 文档之间插入重定向会延迟页面上的所有东西，页面无法渲染，组件也无法开始下载，直到 HTML 文档被送达浏览器。

有一种常见的极其浪费资源的重定向，而且 web 开发人员一般都意识不到这一点，就是 URL 尾部缺少一个斜线的时候。例如，跳转到http://astrology.yahoo.com/astrology会返回一个重定向到http://astrology.yahoo.com/astrology/的301响应（注意添在尾部的斜线）。在Apache中可以用Alias，mod_rewrite或者DirectorySlash指令来取消不必要的重定向。

重定向最常见的用途是把旧站点连接到新的站点，还可以连接同一站点的不同部分，针对用户的不同情况（浏览器类型，用户帐号类型等等）做一些处理。用重定向来连接两个网站是最简单的，只需要少量的额外代码。虽然在这些时候使用重定向减少了开发人员的开发复杂度，但降低了用户体验。一种替代方案是用 Alias 和 mod_rewrite，前提是两个代码路径都在相同的服务器上。如果是因为域名变化而使用了重定向，就可以创建一条 CNAME（创建一个指向另一个域名的 DNS 记录作为别名）结合 Alias 或者 mod_rewrite 指令。

### （四）让 Ajax 可缓存

Ajax 的一个好处是可以给用户提供即时反馈，因为它能够从后台服务器异步请求信息。然而，用了 Ajax 就无法保证用户在等待异步 JavaScript 和 XML 响应返回期间不会非常无聊。在很多应用程序中，用户能够一直等待取决于如何使用 Ajax。例如，在基于 web 的电子邮件客户端中，用户为了寻找符合他们搜索标准的邮件消息，将会保持对 Ajax 请求返回结果的关注。重要的是，要记得“异步”并不意味着“即时”。

要提高性能，优化这些 Ajax 响应至关重要。最重要的提高 Ajax 性能的方法就是让响应变得可缓存，就像在添上 Expires 或者 Cache-Control HTTP 头中讨论的一样。下面适用于 Ajax 的其它规则：

1. Gzip 组件
2. 减少 DNS 查找
3. 压缩 JavaScript
4. 避免重定向
5. 配置 ETags

我们一起看看例子，一个 Web 2.0 的电子邮件客户端用了 Ajax 来下载用户的通讯录，以便实现自动完成功能。如果用户从上一次使用之后再没有修改过她的通讯录，而且 Ajax 响应是可缓存的，有尚未过期的 Expires 或者 Cache-Control HTTP 头，那么之前的通讯录就可以从缓存中读出。必须通知浏览器，应该继续使用之前缓存的通讯录响应，还是去请求一个新的。可以通过给通讯录的 Ajax URL 里添加一个表明用户通讯录最后修改时间的时间戳来实现，例如&t=1190241612。如果通讯录从上一次下载之后再没有被修改过，时间戳不变，通讯录就将从浏览器缓存中直接读出，从而避免一次额外的 HTTP 往返消耗。如果用户已经修改了通讯录，时间戳也可以确保新的 URL 不会匹配缓存的响应，浏览器将请求新的通讯录条目。

即使 Ajax 响应是动态创建的，而且可能只适用于单用户，它们也可以被缓存，而这样会让你的 Web 2.0 应用更快。

### （五）延迟加载组件

看看页面并问自己：什么才是一开始渲染页面所必须的？其余内容都可以等会儿。

JavaScript 是分隔 onload 事件之前和之后的一个理想选择。例如，如果有 JavaScript 代码和支持拖放以及动画的库，这些都可以先等会儿，因为拖放元素是在页面最初渲染之后的。其它可以延迟加载的部分包括隐藏内容（在某个交互动作之后才出现的内容）和折叠的图片。

工具可帮你减轻工作量：YUI Image Loader 可以延迟加载折叠的图片，还有 YUI Get utility 是一种引入 JS 和 CSS 的简单方法。Yahoo!主页就是一个例子，可以打开 Firebug 的网络面板仔细看看。

最好让性能目标符合其它 web 开发最佳实践，比如“渐进增强”。如果客户端支持 JavaScript，可以提高用户体验，但必须确保页面在不支持 JavaScript 时也能正常工作。所以，在确定页面运行正常之后，可以用一些延迟加载脚本增强它，以支持一些拖放和动画之类的华丽效果。

### （六）预加载组件

预加载可能看起来和延迟加载是相反的，但它其实有不同的目标。通过预加载组件可以充分利用浏览器空闲的时间来请求将来会用到的组件（图片，样式和脚本）。用户访问下一页的时候，大部分组件都已经在缓存里了，所以在用户看来页面会加载得更快。

实际应用中有以下几种预加载的类型：

1. 无条件预加载——尽快开始加载，获取一些额外的组件。google.com 就是一个 sprite 图片预加载的好例子，这个 sprite 图片并不是 google.com 主页需要的，而是搜索结果页面上的内容。
2. 条件性预加载——根据用户操作猜测用户将要跳转到哪里并据此预加载。在 search.yahoo.com 的输入框里键入内容后，可以看到那些额外组件是怎样请求加载的。
3. 提前预加载——在推出新设计之前预加载。经常在重新设计之后会听到：“这个新网站不错，但比以前更慢了”，一部分原因是用户访问先前的页面都是有旧缓存的，但新的却是一种空缓存状态下的体验。可以通过在将要推出新设计之前预加载一些组件来减轻这种负面影响，老站可以利用浏览器空闲的时间来请求那些新站需要的图片和脚本。

### （七）减少 DOM 元素的数量

一个复杂的页面意味着要下载更多的字节，而且用 JavaScript 访问 DOM 也会更慢。举个例子，想要添加一个事件处理器的时候，循环遍历页面上的 500 个 DOM 元素和 5000 个 DOM 元素是有区别的。

大量的 DOM 元素是一种征兆——页面上有些内容无关的标记需要清理。正在用嵌套表格来布局吗？还是为了修复布局问题而添了一堆的`<div>s`？或许应该用更好的语义化标记。

YUI CSS utilities 对布局有很大帮助：grids.css 针对整体布局，fonts.css 和 reset.css 可以用来去除浏览器的默认格式。这是个开始清理和思考标记的好机会，例如只在语义上有意义的时候使用`<div>`，而不是因为它能够渲染一个新行。

DOM 元素的数量很容易测试，只需要在 Firebug 的控制台里输入：`document.getElementsByTagName('*').length`

那么多少 DOM 元素才算是太多呢？可以参考其它类似的标记良好的页面，例如 Yahoo!主页是一个相当繁忙的页面，但只有不到 700 个元素（HTML 标签）。

### （八）跨域分离组件

分离组件可以最大化并行下载，但要确保只用不超过 2-4 个域，因为存在 DNS 查找的代价。例如，可以把 HTML 和动态内容部署在www.example.org，而把静态组件分离到static1.example.org和static2.example.org。

### （九）尽量少用 iframe

用 iframe 可以把一个 HTML 文档插入到父文档里，重要的是明白 iframe 是如何工作的并高效地使用它。

- iframe 的优点：

1. 引入缓慢的第三方内容，比如标志和广告
2. 安全沙箱
3. 并行下载脚本

- iframe 的缺点：

1. 代价高昂，即使是空白的 iframe
2. 阻塞页面加载
3. 非语义

### （十）杜绝 404

HTTP 请求代价高昂，完全没有必要用一个 HTTP 请求去获取一个无用的响应（比如 404 Not Found），只会拖慢用户体验而没有任何好处。

有些站点用的是有帮助的 404——“你的意思是 xxx？”，这样做有利于用户体验，，但也浪费了服务器资源（比如数据库等等）。最糟糕的是链接到的外部 JavaScript 有错误而且结果是 404。首先，这种下载将阻塞并行下载。其次，浏览器会试图解析 404 响应体，因为它是 JavaScript 代码，需要找出其中可用的部分。

## 二、CSS 部分

### （十一）合理使用 CSS 表达式

用 CSS 表达式动态设置 CSS 属性，是一种强大又危险的方式。从 IE5 开始支持，但从 IE8 起就不推荐使用了。例如，可以用 CSS 表达式把背景颜色设置成按小时交替的：

`background-color: expression( (new Date()).getHours()%2 ? "#B8D4FF" : "#F08A00" );`

### （十二）尽量选择`<link>`少用`@import`

前面提到了一个最佳实践：为了实现逐步渲染，CSS 应该放在顶部。在 IE 中用`@import`与在底部用`<link>`效果一样，所以最好不要用它。

### （十三）避免使用滤镜

IE 专有的 AlphaImageLoader 滤镜可以用来修复 IE7 之前的版本中半透明 PNG 图片的问题。在图片加载过程中，这个滤镜会阻塞渲染，卡住浏览器，还会增加内存消耗而且是被应用到每个元素的，而不是每个图片，所以会存在一大堆问题。

最好的方法是干脆不要用 AlphaImageLoader，而优雅地降级到用在 IE 中支持性很好的 PNG8 图片来代替。如果非要用 AlphaImageLoader，应该用下划线 hack：\_filter 来避免影响 IE7 及更高版本的用户。

### （十四）把样式表放在顶部

在 Yahoo!研究性能的时候，我们发现把样式表放到文档的 HEAD 部分能让页面看起来加载地更快。这是因为把样式表放在 head 里能让页面逐步渲染。

关注性能的前端工程师想让页面逐步渲染。也就是说，我们想让浏览器尽快显示已有内容，这在页面上有一大堆内容或者用户网速很慢时显得尤为重要。给用户显示反馈（比如进度指标）的重要性已经被广泛研究过，并且被记录下来了。在我们的例子中，HTML 页面就是进度指标！当浏览器逐渐加载页面头部，导航条，顶部 logo 等等内容的时候，这些都被正在等待页面加载的用户当作反馈，能够提高整体用户体验。

## 三、JS 部分

### （十五）去除重复脚本

### （十六）尽量减少 DOM 访问

### （十七）用智能的事件处理器

### （十八）把脚本放在底部

## 四、JavaScript、CSS

### （十九）把 JavaScript 和 CSS 放到外面

### （二十）压缩 JavaScript 和 CSS

## 五、图片

### （二十一）优化图片

### （二十二）优化 CSS Sprite

### （二十三）不要用 HTML/CSS 缩放图片

### （二十四）用小的可缓存的 favicon.ico（P.S. 收藏夹图标）

## 六、Cookie

### （二十五）尽量减少 Cookie 的大小

### （二十六）把组件放在不含 Cookie 的域下

## 七、移动端

### （二十七）保证所有组件都小于 25K

### （二十八）把组件打包到一个复合文档里

## 八、服务器

### （二十九）Gzip 组件

### （三十）避免图片 src 属性为空

### （三十一）配置 ETags

### （三十二）对 Ajax 用 GET 请求

### （三十三）尽早清空缓冲区

### （三十四）使用 CDN（内容分发网络）

### （三十五）添上 Expires 或者 Cache-Control HTTP 请求头
