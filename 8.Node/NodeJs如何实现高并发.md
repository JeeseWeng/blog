# node 如何实现高并发？

nodejs 是非阻塞异步操作。具有异步 I/O 特性，每当有 I/O 请求发生时，node 会提供给该请求一个 I/O 线程。然后 node 就不管这个 I/O 的操作过程了，而是继续执行主线程上的事件，只需要在该请求返回回调时在处理即可。也就是 node 省去了许多等待请求的时间。

## node 特点：

1. Chrome V8 引擎
2. 事件驱动
3. 非阻塞 I/O
4. 单线程

## node 实现高并发的方法：

1. 针对每个并发请求，服务端给请求注册一个激发事件（I/O），并给一个回调函数（这个过程没有阻塞新的连接请求）。
2. 按顺序执行事件处理（I/O），处理完成后执行回调函数，接着执行下一个事件处理（I/O）。
3. Node.js 最大并发连接数为 1000。
4. Nodejs 的非阻塞模型有利于高并发百万人。

## 事件处理（I/O）原理

事件处理（即异步 I/O 处理）是由 node 工作线程去执行的（nodejs 底层的 libuv 是由多线程的线程池并行 I/O 操作），且主线程是不需要等待返回的，只要发出指令后就可以执行其他事件，所有操作完成后执行回调。

I/O 是 Input/Output 的缩写。查询数据库、读取文件或者是访问网络，或者是读取文件流。

## NodeJS 的优缺点

- 优点：

1. 高并发；
2. 适合 I/O 密集型应用。

- 缺点：

1. 不适合 CPU 密集型应用，只支持单核 CPU，不能充分利用 CPU；
2. 单进程，单线程，一旦代码某处出现 bug，整个系统都崩溃；

## 如何解决 CPU 密集型？

原因：由于 JavaScript 单线程的原因，如果有长时间运行的计算（比如大循环），将会导致 CPU 时间片不能释放，使得后续 I/O 无法发起。

解决方案：分解大型运算任务为多个小任务，使得运算能够适时释放，不阻塞 I/O 调用的发起。

单进程、单线程解决方案：Nginx 反向代理，负载均衡，开多个进程，绑定多个端口；开多个进程监听同一个端口，使用 cluster 模块。

nodeJs cluster 模块资料：https://blog.csdn.net/qq_30113287/article/details/108050284

Node.js 默认单进程运行，对于 32 位系统最高可以使用 512MB 内存，对于 64 位最高可以使用 1GB 内存。对于多核 CPU 的计算机来说，这样做效率很低，因为只有一个核在运行，其他核都在闲置。cluster 模块就是为了解决这个问题而提出的。

- cluster 模块允许设立一个主进程和若干个 worker 进程，由主进程监控和协调 worker 进程的运行。
- worker 之间采用进程间通信交换消息，cluster 模块内置一个负载均衡器，采用 Round-robin 算法协调各个 worker 进程之间的负载。
- 运行时，所有新建立的链接都由主进程完成，然后主进程再把 TCP 连接分配给指定的 worker 进程。
